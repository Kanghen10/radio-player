<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radio Player</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }
    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.18;
      z-index: 0;
      transition: opacity .6s ease, background-image .6s ease;
      background-color: #000;
    }
    #player {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: #000;
      display: block;
      z-index: 1;
    }
    #info {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      pointer-events: none;
    }
    #msg {
      color: #fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      text-align: center;
      background: rgba(0,0,0,0.45);
      padding: 14px 18px;
      border-radius: 8px;
      pointer-events: auto;
    }
    #play-btn {
      margin-top: 8px;
      display:inline-block;
      padding:8px 14px;
      border-radius:6px;
      border: none;
      background:#1a73e8;
      color:white;
      cursor:pointer;
      font-weight:600;
    }
    a.small {
      display:block;
      color:#ddd;
      font-size:12px;
      margin-top:8px;
      text-decoration:underline;
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <!-- ✅ tambahkan muted untuk memperbesar kemungkinan autoplay sukses -->
  <audio id="player" autoplay playsinline muted></audio>

  <div id="info">
    <div id="msg">Memuat...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    let PROXY_BASE = null; 
    const CORS_FALLBACK = "https://api.allorigins.win/raw?url=";

    const audio = document.getElementById('player');
    const bg = document.getElementById('background');
    const msg = document.getElementById('msg');

    function setMessage(html){ msg.innerHTML = html; }
    function safeLog(...args){ console.log('[RADIO]', ...args); }

    function showTapToPlay(){
      setMessage('Autoplay diblokir oleh browser.<br><button id="play-btn">Tap untuk putar</button>');
      document.getElementById('play-btn').onclick = () => {
        audio.play().then(()=>audio.muted=false).catch(e=>console.warn(e));
      };
    }

    const rawHash = decodeURIComponent(location.hash.substring(1) || '').trim();
    let streamUrl = rawHash;
    if (rawHash && rawHash.startsWith('proxy=')){
      const idx = rawHash.indexOf('|');
      if (idx > -1){
        const p = rawHash.substring(6, idx);
        const s = rawHash.substring(idx+1);
        if (p) PROXY_BASE = p;
        streamUrl = s;
      }
    }

    if (!streamUrl){
      setMessage('❌ Tidak ada stream URL pada hash.<br>Contoh:<br><code>https://.../radio-player/#https://stream.example.com/stream.mp3</code>');
      throw new Error('no stream URL');
    }

    function extOf(u){
      try{ return (new URL(u)).pathname.split('.').pop().toLowerCase(); }
      catch(e){ return u.split('.').pop().toLowerCase(); }
    }

    async function fetchTextWithFallback(url){
      try {
        const r = await fetch(url);
        if (r.ok) return await r.text();
        throw new Error('non-ok');
      } catch (err) {
        try {
          const r2 = await fetch(CORS_FALLBACK + encodeURIComponent(url));
          if (r2.ok) return await r2.text();
        } catch (e2) {
          console.warn('fetchTextWithFallback failed', url, err, e2);
        }
        return null;
      }
    }

    function parseM3U(text, baseUrl){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for (const l of lines){
        if (l.startsWith('#')) continue;
        if (l.startsWith('http')) return l;
        if (baseUrl){
          try{ return (new URL(l, baseUrl)).href; }catch(e){}
        }
      }
      return null;
    }

    function parsePLS(text){
      const lines = text.split(/\r?\n/);
      for (const l of lines){
        if (/^File\d+=/i.test(l)){
          const v = l.split('=')[1].trim();
          if (v) return v;
        }
      }
      return null;
    }

    async function tryResolvePlaylist(url){
      const ext = extOf(url);
      if (ext === 'm3u8') return url;
      if (!(ext === 'm3u' || ext === 'pls' || url.includes('.m3u') || url.includes('.pls'))) return null;
      setMessage('Mendeteksi playlist...');
      const txt = await fetchTextWithFallback(url);
      if (!txt) return null;
      if (ext === 'pls' || txt.toLowerCase().includes('[playlist]')) {
        return parsePLS(txt);
      } else {
        return parseM3U(txt, url);
      }
    }

    async function attemptGetCoverFromSite(url){
      try{
        const origin = (new URL(url)).origin;
        // cek status-json.xsl (Icecast)
        const statusJson = await fetchTextWithFallback(origin + '/status-json.xsl');
        if (statusJson){
          try{
            const j = JSON.parse(statusJson);
            const sources = j.icestats && j.icestats.source 
              ? (Array.isArray(j.icestats.source) ? j.icestats.source : [j.icestats.source]) 
              : null;
            if (sources && sources.length){
              const s0 = sources[0];
              if (s0.server_name && s0.server_name.includes('http')) return s0.server_name;
              if (s0.title && s0.title.includes('http')) return s0.title;
            }
          }catch(e){}
        }
        // fallback ke og:image
        const html = await fetchTextWithFallback(origin);
        if (!html) return null;
        const m = html.match(/<meta[^>]*property=["']og:image["'][^>]*content=["']([^"']+)["']/i)
              || html.match(/<meta[^>]*name=["']twitter:image["'][^>]*content=["']([^"']+)["']/i)
              || html.match(/<link[^>]*rel=["']image_src["'][^>]*href=["']([^"']+)["']/i);
        if (m) {
          try{ return (new URL(m[1], origin)).href; } catch(e){ return m[1]; }
        }
      }catch(e){ console.warn('cover fetch err', e); }
      return null;
    }

    (async ()=>{
      try{
        setMessage('Memproses URL stream...');
        safeLog('raw stream url:', streamUrl);

        let resolved = await tryResolvePlaylist(streamUrl);
        if (resolved) streamUrl = resolved;

        function buildProxyUrl(u){
          if (!PROXY_BASE) return u;
          if (PROXY_BASE.endsWith('=')) return PROXY_BASE + encodeURIComponent(u);
          if (PROXY_BASE.indexOf('?') === -1) {
            return PROXY_BASE.replace(/\/$/, '') + '/?url=' + encodeURIComponent(u);
          }
          return PROXY_BASE + encodeURIComponent(u);
        }

        const ext = extOf(streamUrl);
        if (ext === 'm3u8'){
          if (window.Hls && Hls.isSupported()){
            const hls = new Hls();
            hls.loadSource(buildProxyUrl(streamUrl));
            hls.attachMedia(audio);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
              audio.play().then(()=>audio.muted=false).catch(()=>showTapToPlay());
            });
          } else if (audio.canPlayType('application/vnd.apple.mpegurl')){
            audio.src = buildProxyUrl(streamUrl);
            audio.play().then(()=>audio.muted=false).catch(()=>showTapToPlay());
          } else {
            setMessage('Browser tidak mendukung HLS.');
          }
        } else {
          const finalUrl = buildProxyUrl(streamUrl);
          audio.src = finalUrl;
          audio.controls = false;
          audio.autoplay = true;
          audio.load();
          audio.play().then(()=>{
            audio.muted = false;
            setMessage('Sedang memutar...');
            setTimeout(()=>{ document.getElementById('info').style.display='none'; }, 600);
          }).catch(()=>showTapToPlay());
        }

        const cover = await attemptGetCoverFromSite(streamUrl);
        if (cover){
          bg.style.backgroundImage = `url("${cover}")`;
          bg.style.opacity = '0.25';
          safeLog('cover set:', cover);
        } else {
          bg.style.backgroundImage = '';
          safeLog('no cover found');
        }

        audio.addEventListener('error', (e)=>{
          console.error('Audio error', audio.error);
          setMessage('❌ Gagal memutar stream. Server mungkin blokir CORS atau format tidak didukung.');
        });

      }catch(err){
        console.error(err);
        setMessage('Terjadi kesalahan: ' + err.message);
      }
    })();
  </script>
</body>
</html>
